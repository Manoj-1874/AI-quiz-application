<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI-Powered HTML Quiz - Quiz Master</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    .floating-timer {
      position: fixed;
      top: 90px;
      right: 20px;
      background-color: #4361ee;
      color: white;
      padding: 12px 20px;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: flex;
      align-items: center;
      font-weight: 600;
      animation: fadeIn 0.5s ease-out;
    }
  
    .timer-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }
  
    .timer-content i {
      font-size: 1.2rem;
    }
  
    #timer-display {
      font-size: 1.2rem;
      letter-spacing: 1px;
    }
  
    .timer-warning {
      background-color: #ff9800;
      animation: pulse 1s infinite;
    }
  
    .timer-danger {
      background-color: #f44336;
      animation: pulse 0.5s infinite;
    }
  
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      color: #333;
      line-height: 1.6;
      background-color: #f0f4ff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px;
      width: 100%;
    }
    
    .navbar {
      background-color: #ffffff;
      box-shadow: 0 4px 20px rgba(67, 97, 238, 0.15);
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      padding: 18px 0;
    }
    
    .nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .logo {
      display: flex;
      align-items: center;
      font-size: 1.7rem;
      font-weight: 700;
      color: #4361ee;
      text-decoration: none;
      transition: transform 0.3s;
    }
    
    .logo:hover {
      transform: scale(1.05);
    }
    
    .logo i {
      margin-right: 12px;
      font-size: 1.9rem;
    }
    
    nav {
      display: flex;
      gap: 32px;
    }
    
    nav a {
      text-decoration: none;
      color: #333;
      font-weight: 500;
      font-size: 1.1rem;
      transition: color 0.3s, transform 0.2s;
      display: flex;
      align-items: center;
    }
    
    nav a i {
      margin-right: 8px;
    }
    
    nav a:hover {
      color: #4361ee;
      transform: translateY(-2px);
    }
    
    .nav-button {
      background-color: #4361ee;
      color: white;
      padding: 10px 24px;
      border-radius: 30px;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
    }
    
    .nav-button:hover {
      background-color: #3a56d4;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(67, 97, 238, 0.4);
    }
    
    .main-content {
      margin-top: 100px;
      flex: 1;
      padding-bottom: 50px;
    }
    
    .quiz-header {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px;
      border-radius: 15px;
      background: linear-gradient(135deg, #4361ee, #3a56d4);
      color: white;
      box-shadow: 0 10px 25px rgba(67, 97, 238, 0.25);
    }
    
    .quiz-header h1 {
      font-size: 2.5rem;
      margin-bottom: 15px;
      letter-spacing: 0.5px;
    }
    
    .quiz-header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .quiz-container {
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      padding: 40px;
      margin-bottom: 30px;
      transition: transform 0.3s;
    }
    
    .quiz-container:hover {
      transform: translateY(-5px);
    }
    
    .question {
      margin-bottom: 35px;
      padding-bottom: 30px;
      border-bottom: 1px solid #eee;
    }
    
    .question:last-child {
      border-bottom: none;
      margin-bottom: 10px;
    }
    
    .question p {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 25px;
      color: #2d3748;
      font-family: 'Poppins', sans-serif;
      line-height: 1.6;
    }
    
    .options {
      margin-left: 15px;
    }
    
    .option {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
      padding: 15px 20px;
      border-radius: 10px;
      transition: all 0.3s ease;
      border: 2px solid #e2e8f0;
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .option:hover {
      background-color: #f8f9ff;
      transform: translateX(5px);
      border-color: #4361ee;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.15);
    }
    
    .option input[type="radio"] {
      margin-right: 15px;
      cursor: pointer;
      width: 20px;
      height: 20px;
      accent-color: #4361ee;
      transform: scale(1.2);
    }
    
    .option label {
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 500;
      width: 100%;
      color: #2d3748;
      font-family: 'Poppins', sans-serif;
      line-height: 1.5;
      user-select: none;
    }
    
    .option input[type="radio"]:checked + label {
      color: #4361ee;
      font-weight: 600;
    }
    
    .option:has(input[type="radio"]:checked) {
      background-color: #f0f4ff;
      border-color: #4361ee;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
    }
    
    /* Fix for browsers that don't support :has() */
    .option.selected {
      background-color: #f0f4ff;
      border-color: #4361ee;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
    }
    
    .option.selected label {
      color: #4361ee;
      font-weight: 600;
    }
    
    .submit-btn {
      background: linear-gradient(135deg, #4361ee, #3a56d4);
      color: white;
      border: none;
      padding: 16px 36px;
      border-radius: 10px;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: block;
      margin: 30px auto 10px;
      font-family: 'Poppins', sans-serif;
      box-shadow: 0 6px 15px rgba(67, 97, 238, 0.3);
    }
    
    .submit-btn:hover {
      background: linear-gradient(135deg, #3a56d4, #2845c2);
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
    }
    
    .submit-btn:active {
      transform: scale(0.98);
    }
    
    .submit-btn:disabled {
      background: linear-gradient(135deg, #cbd5e0, #a0aec0);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .submit-btn:disabled:hover {
      background: linear-gradient(135deg, #cbd5e0, #a0aec0);
      transform: none;
      box-shadow: none;
    }
    
    #resultContainer {
      display: none;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      padding: 40px;
    }
    
    .result-header {
      text-align: center;
      margin-bottom: 35px;
      background: linear-gradient(135deg, #4361ee, #3a56d4);
      padding: 25px;
      border-radius: 15px;
      color: white;
      box-shadow: 0 10px 25px rgba(67, 97, 238, 0.25);
    }
    
    .result-header h2 {
      font-size: 2.2rem;
      margin-bottom: 10px;
    }
    
    .result-header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .score-display {
      font-size: 3.5rem;
      font-weight: 700;
      color: #4361ee;
      text-align: center;
      margin: 30px 0;
      text-shadow: 0 2px 5px rgba(67, 97, 238, 0.2);
    }
    
    .performance-charts {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-bottom: 40px;
    }
    
    .chart-container {
      width: 48%;
      margin-bottom: 30px;
      background-color: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s;
    }
    
    .chart-container:hover {
      transform: translateY(-5px);
    }
    
    #categoryChart {
      height: 350px !important;
    }
    
    .improvement-section {
      margin-top: 40px;
    }
    
    .improvement-section h3 {
      color: #4361ee;
      margin-bottom: 20px;
      font-size: 1.5rem;
      position: relative;
      padding-left: 15px;
    }
    
    .improvement-section h3::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 5px;
      background: linear-gradient(to bottom, #4361ee, #7a97ff);
      border-radius: 5px;
    }
    
    .weak-areas {
      background-color: #fff8f8;
      border-left: 5px solid #ff6b6b;
      padding: 25px;
      margin-bottom: 30px;
      border-radius: 0 15px 15px 0;
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.1);
    }
    
    .weak-areas h4 {
      color: #e74c3c;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    .weak-areas ul {
      margin-left: 25px;
    }
    
    .weak-areas li {
      margin-bottom: 12px;
      font-size: 1.1rem;
    }
    
    .resources {
      background-color: #f0f7ff;
      border-left: 5px solid #4361ee;
      padding: 25px;
      border-radius: 0 15px 15px 0;
      box-shadow: 0 5px 15px rgba(67, 97, 238, 0.1);
    }
    
    .resources h4 {
      color: #4361ee;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    .resources ul {
      margin-left: 25px;
    }
    
    .resources li {
      margin-bottom: 12px;
      font-size: 1.1rem;
    }
    
    .resources a {
      color: #4361ee;
      text-decoration: none;
      transition: color 0.3s;
      font-weight: 500;
    }
    
    .resources a:hover {
      text-decoration: underline;
      color: #3a56d4;
    }
    
    .action-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 40px;
    }
    
    .action-link {
      text-decoration: none;
      padding: 14px 30px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s;
      font-size: 1.1rem;
    }
    
    .primary-link {
      background: linear-gradient(135deg, #4361ee, #3a56d4);
      color: white;
      box-shadow: 0 6px 15px rgba(67, 97, 238, 0.3);
    }
    
    .primary-link:hover {
      background: linear-gradient(135deg, #3a56d4, #2845c2);
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
    }
    
    .secondary-link {
      background-color: #f8f9fa;
      color: #333;
      border: 2px solid #ddd;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    
    .secondary-link:hover {
      background-color: #eaecef;
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
    }
    
    footer {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      padding: 30px 0;
      margin-top: auto;
    }
    
    .footer-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .footer-links {
      display: flex;
      gap: 25px;
    }
    
    .footer-links a {
      color: #b3b3b3;
      text-decoration: none;
      transition: all 0.3s;
      font-size: 1rem;
      position: relative;
    }
    
    .footer-links a::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -5px;
      left: 0;
      background-color: white;
      transition: width 0.3s;
    }
    
    .footer-links a:hover {
      color: white;
    }
    
    .footer-links a:hover::after {
      width: 100%;
    }
    
    .footer-text {
      color: #b3b3b3;
      font-size: 1rem;
    }
    
    .error-message {
      color: #e74c3c;
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.1rem;
    }
    
    /* Loading state improvements */
    .loading-container {
      text-align: center;
      padding: 60px 40px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }
    
    .loading-spinner {
      font-size: 48px;
      color: #4361ee;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 20px;
      font-size: 18px;
      color: #333;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
    }
    
    .loading-subtext {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
      font-family: 'Poppins', sans-serif;
    }
    
    @media (max-width: 768px) {
      .nav-content {
        flex-direction: column;
        gap: 20px;
      }
      
      nav {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .performance-charts {
        flex-direction: column;
      }
      
      .chart-container {
        width: 100%;
      }
      
      .action-links {
        flex-direction: column;
        align-items: center;
      }
      
      .footer-content {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }
      
      .footer-links {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="nav-content">
      <a href="/" class="logo">
        <i class="fas fa-brain"></i> Quiz Master
      </a>
      <nav>
        <a href="index.html"><i class="fas fa-home"></i> Home</a>
        <a href="/categories.html"><i class="fas fa-list"></i> Categories</a>
        <a href="/leaderboard.html"><i class="fas fa-trophy"></i> Leaderboard</a>
        <a href="#" id="logout-btn" style="display: none;"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </nav>
    </div>
  </header>

  <div id="quiz-timer" class="floating-timer">
    <div class="timer-content">
      <i class="fas fa-clock"></i>
      <span id="timer-display">10:00</span>
    </div>
  </div>

  <main class="main-content">
    <div class="container">
      <div class="quiz-header">
        <h1>AI-Powered HTML Quiz Challenge</h1>
        <p>Test your HTML skills with 10 dynamically generated questions powered by AI!</p>
      </div>

      <form id="quizForm">
        <input type="hidden" name="category" value="HTML">
        <div class="quiz-container" id="quiz-container">
          <!-- Questions will be dynamically inserted here -->
        </div>
        <p id="error-message" class="error-message"></p>
        <button type="submit" class="submit-btn">Submit Answers</button>
      </form>

      <div id="resultContainer">
        <div class="result-header">
          <h2>Your Quiz Results</h2>
          <p>See how well you did and areas for improvement</p>
        </div>
        
        <div class="score-display">
          <span id="scoreValue">0</span>/<span id="totalQuestions">0</span>
        </div>
        
        <div class="performance-charts">
          <div class="chart-container">
            <canvas id="scoreChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
        
        <div class="improvement-section">
          <h3>Performance Analysis</h3>
          
          <div id="weakAreas" class="weak-areas">
            <h4>Areas for Improvement</h4>
            <ul id="weakAreasList"></ul>
          </div>
          
          <div class="resources">
            <h4>Recommended Resources</h4>
            <ul id="resourcesList"></ul>
          </div>
        </div>
        
        <div class="action-links">
          <a href="/categories.html" class="action-link primary-link">Try Another Quiz</a>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-links">
        <a href="/about.html">About Us</a>
        <a href="/contact.html">Contact</a>
        <a href="/policy.html">Privacy Policy</a>
        <a href="/terms.html">Terms of Use</a>
      </div>
      <div class="footer-text">
        ¬© 2025 Quiz Master. All rights reserved.
      </div>
    </div>
  </footer>

  <script>
    // Add missing global variables at the top
    let questions = [];
    let currentQuestionIndex = 0;
    let previousAnswers = [];
    let isQuizFinished = false;
    let startTime = new Date();
    let aiSystemStatus = {};
    const totalQuestions = 10;

    // Add missing resource map
    const resourceMap = {
      'HTML Basics': [
        { text: 'MDN HTML Basics', url: 'https://developer.mozilla.org/en-US/docs/Learn/Getting_started_with_the_web/HTML_basics' },
        { text: 'W3Schools HTML Tutorial', url: 'https://www.w3schools.com/html/' }
      ],
      'HTML Elements': [
        { text: 'MDN HTML Elements Reference', url: 'https://developer.mozilla.org/en-US/docs/Web/HTML/Element' },
        { text: 'HTML Elements Guide', url: 'https://www.w3schools.com/html/html_elements.asp' }
      ],
      'HTML Forms': [
        { text: 'MDN HTML Forms', url: 'https://developer.mozilla.org/en-US/docs/Learn/Forms' },
        { text: 'HTML Forms Tutorial', url: 'https://www.w3schools.com/html/html_forms.asp' }
      ],
      'HTML Tables': [
        { text: 'MDN HTML Tables', url: 'https://developer.mozilla.org/en-US/docs/Learn/HTML/Tables' },
        { text: 'HTML Tables Guide', url: 'https://www.w3schools.com/html/html_tables.asp' }
      ],
      'HTML5 Semantic Elements': [
        { text: 'MDN Semantic HTML', url: 'https://developer.mozilla.org/en-US/docs/Glossary/Semantics#semantics_in_html' },
        { text: 'HTML5 Semantic Elements', url: 'https://www.w3schools.com/html/html5_semantic_elements.asp' }
      ],
      'HTML Attributes': [
        { text: 'MDN HTML Attributes', url: 'https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes' },
        { text: 'HTML Attributes Reference', url: 'https://www.w3schools.com/html/html_attributes.asp' }
      ]
    };

    // Add missing helper functions before the main functions
    function calculateUserLevel() {
      if (previousAnswers.length === 0) return 'beginner';
      const correctCount = previousAnswers.filter(a => a.isCorrect).length;
      const accuracy = correctCount / previousAnswers.length;
      
      if (accuracy >= 0.8) return 'advanced';
      if (accuracy >= 0.6) return 'intermediate';
      return 'beginner';
    }

    function getStrongAreas() {
      const topicCounts = {};
      previousAnswers.filter(a => a.isCorrect).forEach(a => {
        topicCounts[a.topic] = (topicCounts[a.topic] || 0) + 1;
      });
      return Object.keys(topicCounts).filter(topic => topicCounts[topic] >= 2).slice(0, 3);
    }

    function getWeakAreas() {
      const topicCounts = {};
      previousAnswers.filter(a => !a.isCorrect).forEach(a => {
        topicCounts[a.topic] = (topicCounts[a.topic] || 0) + 1;
      });
      return Object.keys(topicCounts).filter(topic => topicCounts[topic] >= 1).slice(0, 3);
    }

    function getPreferredDifficulty() {
      const level = calculateUserLevel();
      return level === 'advanced' ? 'hard' : level === 'intermediate' ? 'medium' : 'easy';
    }

    // Enhanced AI system detection for NEW Cohere
    async function initializeAISystem() {
      console.log('üîß Initializing NEW Cohere AI system...');
      try {
        const response = await fetch('/api/ai-status');
        const result = await response.json();
        aiSystemStatus = result;
        
        console.log('ü§ñ NEW AI System Status:', {
          cohereAvailable: result.cohereAvailable,
          primaryAI: result.primaryAI,
          status: result.status,
          apiVersion: result.apiVersion
        });
        
        if (result.cohereAvailable) {
          console.log('‚úÖ NEW Cohere AI fully operational!');
          return 'NEW_COHERE_READY';
        } else {
          console.log('üìö Using intelligent fallback system');
          return 'FALLBACK_READY';
        }
      } catch (error) {
        console.error('‚ùå NEW AI initialization error:', error);
        return 'FALLBACK_READY';
      }
    }

    // Enhanced AI test function for NEW Cohere
    async function testAI() {
      try {
        console.log('üß™ Testing NEW Cohere AI system...');
        
        const cohereResponse = await fetch('/api/test-cohere');
        const cohereResult = await cohereResponse.json();
        
        if (cohereResult.status === 'SUCCESS') {
          console.log('üöÄ NEW Cohere AI working perfectly!');
          console.log(`‚ö° Response time: ${cohereResult.responseTime}ms`);
          console.log(`üîß API Version: ${cohereResult.apiVersion}`);
          return cohereResult;
        } else {
          console.log('‚ùå NEW Cohere test failed:', cohereResult.error);
          return cohereResult;
        }
        
      } catch (error) {
        console.error('‚ùå NEW AI test failed:', error);
        return { 
          status: 'FAILED', 
          error: error.message, 
          fallbackAvailable: true
        };
      }
    }

    async function loadQuiz() {
      console.log('üöÄ Starting NEW Cohere AI quiz load...');
      
      const user = checkLogin();
      if (!user) {
        console.log('‚ùå User check failed, stopping quiz load');
        return;
      }
      
      try {
        // Initialize NEW AI system first
        const aiStatus = await initializeAISystem();
        console.log('ü§ñ NEW AI initialization complete:', aiStatus);
        
        // Reset quiz state
        questions = [];
        currentQuestionIndex = 0;
        previousAnswers = [];
        isQuizFinished = false;
        startTime = new Date();
        
        // Hide form submission button initially
        const submitBtn = document.querySelector('.submit-btn');
        if (submitBtn) {
          submitBtn.style.display = 'none';
        }
        
        // Show enhanced loading state with NEW AI status
        const quizContainer = document.getElementById('quiz-container');
        if (!quizContainer) {
          console.error('‚ùå Quiz container not found in DOM');
          showErrorState('Quiz container not found');
          return;
        }
        
        const aiStatusText = aiStatus === 'NEW_COHERE_READY' ? 
          'NEW Cohere AI-Powered Question Generation Active' :
          'Smart Adaptive Question System';
        
        console.log('üìù Setting NEW enhanced loading state...');
        quizContainer.innerHTML = `
          <div class="loading-container">
            <i class="fas fa-brain loading-spinner" style="color: #4361ee;"></i>
            <p class="loading-text">üß† Generating your personalized HTML quiz...</p>
            <p class="loading-subtext">${aiStatusText} - Adapting to your skill level</p>
            <div style="margin-top: 15px; padding: 10px; background: #f0f4ff; border-radius: 8px; font-size: 14px; color: #4361ee;">
              <i class="fas fa-robot"></i> ${aiStatus === 'NEW_COHERE_READY' ? 'NEW Cohere AI' : 'Intelligent System'} ‚Ä¢ Adaptive Questions
            </div>
          </div>
        `;
        
        // Load first question dynamically with NEW AI enhancement
        console.log('üîÑ Loading first NEW AI-enhanced question...');
        await loadNextQuestion();
        
        // Start the timer
        console.log('‚è∞ Starting timer...');
        startTimer();
        
      } catch (error) {
        console.error('‚ùå Error loading NEW enhanced quiz:', error);
        showErrorState(error.message);
      }
    }

    async function handleQuestionAnswer() {
      console.log('üîò Handling question answer...');
    
      if (isQuizFinished) {
        console.log('‚ùå Quiz already finished');
        return;
      }
      
      const selectedAnswer = document.querySelector('input[name="currentAnswer"]:checked');
      
      if (!selectedAnswer) {
        console.log('‚ùå No answer selected');
        const errorElement = document.getElementById('error-message');
        if (errorElement) {
          errorElement.textContent = 'Please select an answer before proceeding.';
          errorElement.style.display = 'block';
        }
        return;
      }
      
      const selectedText = selectedAnswer.value;
      const currentQuestion = questions[currentQuestionIndex];
      const isCorrect = selectedText === currentQuestion.correctAnswer;
      const topic = selectedAnswer.getAttribute('data-topic') || 'HTML Basics';
      
      console.log('üìã Answer details:', {
        selected: selectedText,
        correct: currentQuestion.correctAnswer,
        isCorrect,
        topic,
        questionIndex: currentQuestionIndex
      });
      
      // Store answer with detailed information
      previousAnswers.push({
        question: currentQuestion.question,
        selectedAnswer: selectedText,
        correctAnswer: currentQuestion.correctAnswer,
        isCorrect: isCorrect,
        topic: topic,
        timeSpent: Math.floor((new Date() - startTime) / 1000),
        questionIndex: currentQuestionIndex,
        difficulty: currentQuestion.difficulty || 'beginner'
      });
      
      console.log(`‚úÖ Answer ${currentQuestionIndex + 1} stored. Total answers: ${previousAnswers.length}`);
      
      // Show feedback
      showAnswerFeedback(isCorrect, currentQuestion.explanation);
      
      // Move to next question
      currentQuestionIndex++;
      
      if (currentQuestionIndex < totalQuestions) {
        console.log(`üîÑ Moving to question ${currentQuestionIndex + 1}/${totalQuestions}`);
        // Reduced delay for faster progression
        setTimeout(async () => {
          try {
            await loadNextQuestion();
          } catch (error) {
            console.error('‚ùå Error loading next question:', error);
            showErrorState('Failed to load next question. Please refresh the page.');
          }
        }, 2000);
      } else {
        console.log('üèÅ Quiz completed, finishing...');
        isQuizFinished = true;
        setTimeout(() => {
          finishQuiz();
        }, 2000);
      }
    }

    function showAnswerFeedback(isCorrect, explanation) {
      console.log('üìù Showing answer feedback:', { isCorrect, explanation });
      
      const quizContainer = document.getElementById('quiz-container');
      if (!quizContainer) return;
      
      // Create feedback HTML
      const feedbackHTML = `
        <div class="answer-feedback" style="
          padding: 20px; 
          margin: 20px 0; 
          border-radius: 10px; 
          border-left: 5px solid ${isCorrect ? '#10b981' : '#ef4444'};
          background-color: ${isCorrect ? '#f0fdf4' : '#fef2f2'};
          animation: slideIn 0.3s ease-out;
        ">
          <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <i class="fas fa-${isCorrect ? 'check-circle' : 'times-circle'}" 
               style="color: ${isCorrect ? '#10b981' : '#ef4444'}; font-size: 1.5rem; margin-right: 10px;"></i>
            <h4 style="color: ${isCorrect ? '#065f46' : '#991b1b'}; margin: 0; font-size: 1.2rem;">
              ${isCorrect ? 'üéâ Correct!' : '‚ùå Incorrect'}
            </h4>
          </div>
          ${explanation ? `
            <p style="color: #374151; margin: 0; font-size: 1rem; line-height: 1.5;">
              <strong>Explanation:</strong> ${explanation}
            </p>
          ` : ''}
          <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
            Question ${currentQuestionIndex + 1} of ${totalQuestions} completed
          </div>
        </div>
      `;
      
      // Insert feedback after the question
      const questionElement = quizContainer.querySelector('.question');
      if (questionElement) {
        questionElement.insertAdjacentHTML('afterend', feedbackHTML);
      }
      
      // Disable all options after answering
      const allOptions = document.querySelectorAll('.option');
      allOptions.forEach(option => {
        option.style.pointerEvents = 'none';
        option.style.opacity = '0.7';
      });
      
      // Hide submit button temporarily
      const submitBtn = document.querySelector('.submit-btn');
      if (submitBtn) {
        submitBtn.style.display = 'none';
      }
    }

    // Enhanced form submission event listener
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM loaded, initializing NEW Cohere AI quiz...');
      
      // Add comprehensive form submit handler
      const quizForm = document.getElementById('quizForm');
      if (quizForm) {
        quizForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log('üìù Form submitted via form event, handling answer...');
          handleQuestionAnswer();
        });
      }
      
      // Add click handler for submit button (event delegation)
      document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('submit-btn') && !e.target.disabled) {
          e.preventDefault();
          console.log('üìù Submit button clicked, handling answer...');
          handleQuestionAnswer();
        }
      });
      
      // Handle option clicks
      document.addEventListener('click', function(e) {
        if (e.target && e.target.closest('.option')) {
          const option = e.target.closest('.option');
          selectOption(option);
        }
      });

      // Handle radio button changes
      document.addEventListener('change', function(e) {
        if (e.target && e.target.name === 'currentAnswer') {
          console.log('üìª Radio button changed:', e.target.value);
          handleOptionChange();
        }
      });
      
      // Start quiz immediately
      setTimeout(() => {
        console.log('‚ö° Starting NEW Cohere AI quiz load...');
        loadQuiz();
      }, 100);
      
      // Test NEW AI in background
      testAI().then(result => {
        console.log('üß™ Background NEW AI test result:', result.status);
        if (result.status === 'SUCCESS') {
          console.log('üöÄ NEW Cohere AI working perfectly!');
          console.log(`‚ö° Response time: ${result.responseTime}ms`);
        } else {
          console.log('‚ö° Using intelligent fallback system!');
        }
      }).catch(error => {
        console.log('üß™ Background NEW AI test failed:', error.message);
      });
    });

    // Only one definition for handleOptionChange
    function handleOptionChange() {
      console.log('üîÑ Option change detected');
      
      // Enable submit button when any option is selected
      const submitBtn = document.querySelector('.submit-btn');
      if (submitBtn) {
        submitBtn.disabled = false;
        console.log('‚úÖ Submit button enabled via change event');
      }
      
      // Add selected class to the parent option div
      const checkedRadio = document.querySelector('input[name="currentAnswer"]:checked');
      if (checkedRadio) {
        const allOptions = document.querySelectorAll('.option');
        allOptions.forEach(opt => opt.classList.remove('selected'));
        
        const parentOption = checkedRadio.closest('.option');
        if (parentOption) {
          parentOption.classList.add('selected');
        }
        
        // Clear any error messages
        const errorElement = document.getElementById('error-message');
        if (errorElement) {
          errorElement.textContent = '';
          errorElement.style.display = 'none';
        }
      }
    }

    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .option {
        transition: all 0.2s ease;
      }
      
      .option:hover {
        transform: translateX(5px);
      }
      
      .answer-feedback {
        animation: slideIn 0.3s ease-out;
      }
    `;
    document.head.appendChild(style);

    // Add timer functions
    function startTimer() {
      console.log('‚è∞ Starting quiz timer...');
      
      const timerElement = document.getElementById('quiz-timer');
      const timerDisplay = document.getElementById('timer-display');
      
      if (!timerElement || !timerDisplay) {
        console.error('‚ùå Timer elements not found');
        return;
      }
      
      timerElement.style.display = 'block';
      
      let timeLeft = 600; // 10 minutes in seconds
      
      window.countdownTimer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        
        timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color based on time left
        if (timeLeft <= 60) {
          timerElement.className = 'floating-timer timer-danger';
        } else if (timeLeft <= 180) {
          timerElement.className = 'floating-timer timer-warning';
        }
        
        if (timeLeft <= 0) {
          clearInterval(window.countdownTimer);
          alert('Time\'s up! Submitting your current answers.');
          finishQuiz();
        }
        
        timeLeft--;
      }, 1000);
    }

    function finishQuiz() {
      console.log('üèÅ Finishing quiz...');
      
      // Stop timer
      if (window.countdownTimer) {
        clearInterval(window.countdownTimer);
      }
      
      // Hide timer
      const timerElement = document.getElementById('quiz-timer');
      if (timerElement) {
        timerElement.style.display = 'none';
      }
      
      // Calculate score
      const score = previousAnswers.filter(a => a.isCorrect).length;
      const percentage = Math.round((score / totalQuestions) * 100);
      
      console.log(`üìä Final score: ${score}/${totalQuestions} (${percentage}%)`);
      
      // Submit to backend
      submitQuizResults(score, totalQuestions, previousAnswers);
      
      // Show results
      displayResults(score, totalQuestions, percentage);
    }

    async function submitQuizResults(score, total, answers) {
      console.log('üì§ Submitting quiz results to backend...');
      
      const user = checkLogin();
      if (!user) return;
      
      try {
        const questionIds = questions.map(q => q.id || null);
        
        const response = await fetch('/submit-quiz', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: user.username,
            email: user.email,
            category: 'HTML',
            score: score,
            total: total,
            answers: answers,
            timeSpent: Math.floor((new Date() - startTime) / 1000),
            questionIds: questionIds
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('‚úÖ Quiz results submitted successfully:', result);
        } else {
          console.error('‚ùå Failed to submit quiz results:', response.status);
        }
      } catch (error) {
        console.error('‚ùå Error submitting quiz results:', error);
      }
    }

    function displayResults(score, total, percentage) {
      console.log('üìä Displaying quiz results...');
      
      // Hide quiz form
      const quizForm = document.getElementById('quizForm');
      if (quizForm) {
        quizForm.style.display = 'none';
      }
      
      // Show results container
      const resultContainer = document.getElementById('resultContainer');
      if (resultContainer) {
        resultContainer.style.display = 'block';
        
        // Update score display
        const scoreValue = document.getElementById('scoreValue');
        const totalQuestionsSpan = document.getElementById('totalQuestions');
        
        if (scoreValue) scoreValue.textContent = score;
        if (totalQuestionsSpan) totalQuestionsSpan.textContent = total;
        
        // Add charts and analysis
        createPerformanceCharts(score, total, percentage);
        showImprovementAreas();
      }
      
      // Scroll to results
      setTimeout(() => {
        if (resultContainer) {
          resultContainer.scrollIntoView({ behavior: 'smooth' });
        }
      }, 100);
    }

    function createPerformanceCharts(score, total, percentage) {
      // Score chart
      const scoreCtx = document.getElementById('scoreChart');
      if (scoreCtx) {
        new Chart(scoreCtx, {
          type: 'doughnut',
          data: {
            labels: ['Correct', 'Incorrect'],
            datasets: [{
              data: [score, total - score],
              backgroundColor: ['#10b981', '#ef4444'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: `Your Score: ${percentage}%`
              }
            }
          }
        });
      }
      
      // Category performance chart
      const categoryCtx = document.getElementById('categoryChart');
      if (categoryCtx) {
        const topicPerformance = {};
        
        previousAnswers.forEach(answer => {
          const topic = answer.topic || 'HTML Basics';
          if (!topicPerformance[topic]) {
            topicPerformance[topic] = { correct: 0, total: 0 };
          }
          topicPerformance[topic].total++;
          if (answer.isCorrect) {
            topicPerformance[topic].correct++;
          }
        });
        
        const labels = Object.keys(topicPerformance);
        const data = labels.map(topic => {
          const perf = topicPerformance[topic];
          return Math.round((perf.correct / perf.total) * 100);
        });
        
        new Chart(categoryCtx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Accuracy %',
              data: data,
              backgroundColor: '#4361ee',
              borderRadius: 5
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: 'Performance by Topic'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100
              }
            }
          }
        });
      }
    }

    function showImprovementAreas() {
      // Analyze weak areas
      const topicPerformance = {};
      
      previousAnswers.forEach(answer => {
        const topic = answer.topic || 'HTML Basics';
        if (!topicPerformance[topic]) {
          topicPerformance[topic] = { correct: 0, total: 0 };
        }
        topicPerformance[topic].total++;
        if (answer.isCorrect) {
          topicPerformance[topic].correct++;
        }
      });
      
      const weakAreas = Object.entries(topicPerformance)
        .filter(([topic, perf]) => (perf.correct / perf.total) < 0.7)
        .map(([topic]) => topic);
      
      // Update weak areas list
      const weakAreasList = document.getElementById('weakAreasList');
      if (weakAreasList) {
        if (weakAreas.length > 0) {
          weakAreasList.innerHTML = weakAreas.map(area => `<li>${area}</li>`).join('');
        } else {
          weakAreasList.innerHTML = '<li>Great job! No major weak areas identified.</li>';
        }
      }
      
      // Update resources list
      const resourcesList = document.getElementById('resourcesList');
      if (resourcesList && weakAreas.length > 0) {
        const resources = [];
        weakAreas.forEach(area => {
          if (resourceMap[area]) {
            resources.push(...resourceMap[area]);
          }
        });
        
        if (resources.length > 0) {
          resourcesList.innerHTML = resources.map(resource => 
            `<li><a href="${resource.url}" target="_blank">${resource.text}</a></li>`
          ).join('');
        }
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (window.countdownTimer) {
        clearInterval(window.countdownTimer);
      }
    });

    function checkLogin() {
      console.log('üîê Checking login status...');
      
      let user = null;
      
      try {
        // Check if user data exists in localStorage
        const userData = localStorage.getItem('user');
        const email = localStorage.getItem('email');
        const username = localStorage.getItem('username');
        
        console.log('üîç Raw user data:', { userData, email, username });
        
        if (userData) {
          user = JSON.parse(userData);
          console.log('‚úÖ Parsed user data:', user);
        } else if (email && username) {
          user = { email, username };
          console.log('‚úÖ User data from individual keys:', user);
          localStorage.setItem('user', JSON.stringify(user));
        }
        
      } catch (error) {
        console.error('‚ùå Error parsing user data:', error);
      }
      
      // Validate user data
      if (!user || !user.email || !user.username) {
        console.log('‚ùå No valid user data found, redirecting to login');
        alert('Please log in to take the quiz.');
        window.location.href = '/login.html';
        return false;
      }
      
      console.log('‚úÖ User authentication successful:', user);
      return user;
    }

    async function loadNextQuestion() {
      console.log(`üîÑ Loading AI-enhanced question ${currentQuestionIndex + 1} of ${totalQuestions}`);
      
      const user = checkLogin();
      if (!user) {
        console.log('‚ùå User check failed in loadNextQuestion');
        return;
      }
      
      if (currentQuestionIndex >= totalQuestions || isQuizFinished) {
        console.log('‚ùå Quiz already finished or reached total questions');
        return;
      }
      
      try {
        // Show loading state for non-first questions
        if (currentQuestionIndex > 0) {
          const quizContainer = document.getElementById('quiz-container');
          if (quizContainer) {
            quizContainer.innerHTML = `
              <div class="loading-container">
                <i class="fas fa-robot loading-spinner" style="color: #4361ee;"></i>
                <p class="loading-text">‚ö° Fast AI question generation...</p>
                <p class="loading-subtext">Cohere AI ‚Ä¢ Question ${currentQuestionIndex + 1} of ${totalQuestions}</p>
              </div>
            `;
          }
        }
        
        // Make API request with better error handling
        const requestBody = {
          category: 'HTML',
          email: user.email,
          previousAnswers: previousAnswers,
          questionNumber: currentQuestionIndex + 1,
          totalQuestions: totalQuestions,
          aiMode: 'fast',
          userProfile: {
            currentLevel: calculateUserLevel(),
            strongAreas: getStrongAreas(),
            weakAreas: getWeakAreas(),
            preferredDifficulty: getPreferredDifficulty()
          }
        };
        
        console.log('üì§ Sending request to /api/generate-ai-question...');
        
        const response = await fetch('/api/generate-ai-question', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        console.log(`üì° Response status: ${response.status}`);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå API Error:', errorText);
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Received question data:', data);
        
        const question = data.question;
        
        // Validate question structure
        if (!question || !question.options || !Array.isArray(question.options) || question.options.length !== 4) {
          console.error('‚ùå Invalid question structure:', question);
          throw new Error('Invalid question received from API');
        }
        
        if (!question.correctAnswer || !question.options.includes(question.correctAnswer)) {
          console.error('‚ùå Correct answer not in options:', question);
          throw new Error('Question validation failed');
        }
        
        // Store question
        questions.push(question);
        
        console.log(`üéâ Question ${currentQuestionIndex + 1} loaded successfully`);
        console.log(`Generated by: ${data.aiModel || 'Unknown'}`);
        
        // Render question
        setTimeout(() => {
          renderCurrentQuestion(question, data.adaptationInfo || {});
        }, 300);
        
      } catch (error) {
        console.error('‚ùå Error loading question:', error);
        showErrorState(`Failed to load question: ${error.message}`);
      }
    }

    function renderCurrentQuestion(question, adaptationInfo = {}) {
      console.log('üé® Rendering current question');
      
      const quizContainer = document.getElementById('quiz-container');
      if (!quizContainer) return;
      
      const questionHTML = `
        <div class="question" data-question-index="${currentQuestionIndex}">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="background: linear-gradient(90deg, #4361ee, #7209b7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              <i class="fas fa-brain"></i> Question ${currentQuestionIndex + 1} of ${totalQuestions}
            </div>
          </div>
          
          <p style="font-size: 1.25rem; font-weight: 600; margin-bottom: 25px; color: #2d3748; line-height: 1.6;">
            ${escapeHtml(question.question)}
          </p>
          
          <div class="options">
            ${question.options.map((option, index) => {
              const safeOption = escapeHtml(String(option).trim());
              const optionId = `option${currentQuestionIndex}_${index}`;
              return `
                <div class="option" onclick="selectOption(this)">
                  <input type="radio" 
                         id="${optionId}" 
                         name="currentAnswer" 
                         value="${safeOption}" 
                         data-topic="${escapeHtml(question.topic || 'HTML Basics')}"
                         onchange="handleOptionChange()">
                  <label for="${optionId}">${safeOption}</label>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
      
      quizContainer.innerHTML = questionHTML;
      
      // Show submit button
      const submitBtn = document.querySelector('.submit-btn');
      if (submitBtn) {
        submitBtn.style.display = 'block';
        submitBtn.textContent = currentQuestionIndex < totalQuestions - 1 ? 
          `Next Question (${currentQuestionIndex + 2}/${totalQuestions})` : 
          'Submit Quiz';
        submitBtn.disabled = true;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function selectOption(optionElement) {
      console.log('üîò Option selected');
      
      // Remove selected class from all options
      const allOptions = document.querySelectorAll('.option');
      allOptions.forEach(opt => opt.classList.remove('selected'));
      
      // Add selected class to clicked option
      optionElement.classList.add('selected');
      
      // Check the radio button
      const radioButton = optionElement.querySelector('input[type="radio"]');
      if (radioButton) {
        radioButton.checked = true;
      }
      
      // Enable submit button
      const submitBtn = document.querySelector('.submit-btn');
      if (submitBtn) {
        submitBtn.disabled = false;
      }
    }

    function showErrorState(message) {
      const quizContainer = document.getElementById('quiz-container');
      if (!quizContainer) return;
      
      quizContainer.innerHTML = `
        <div class="error-state" style="text-align: center; padding: 40px; background: #fef2f2; border: 2px solid #ef4444; border-radius: 10px; color: #991b1b;">
          <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px; color: #ef4444;"></i>
          <h3 style="margin-bottom: 15px;">Quiz Loading Error</h3>
          <p style="margin-bottom: 20px; font-size: 1.1rem;">${message}</p>
          <button onclick="location.reload()" style="background: #ef4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600;">
            <i class="fas fa-redo"></i> Refresh Page
          </button>
        </div>
      `;
    }

    window.addEventListener("DOMContentLoaded", function () {
      const logoutBtn = document.getElementById("logout-btn");
      const email = localStorage.getItem("email");

      if (email) {
        logoutBtn.style.display = "inline-block";
      }

      logoutBtn.addEventListener("click", function () {
        localStorage.clear();
        alert("You have been logged out.");
        window.location.href = "/login.html";
      });
    });
  </script>
</body>
</html>